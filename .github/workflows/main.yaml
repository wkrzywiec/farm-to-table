name: Build
on:
  push:
    branches:
      - 'main'
  pull_request:
  workflow_dispatch:

jobs:
  bff:
    uses: ./.github/workflows/template-gradle-project-branch.yaml
    with:
      app-name: bff
  
  delivery:
    uses: ./.github/workflows/template-gradle-project-branch.yaml
    with:
      app-name: delivery
  
  food:
    uses: ./.github/workflows/template-gradle-project-branch.yaml
    with:
      app-name: food
  
  ordering:
    uses: ./.github/workflows/template-gradle-project-branch.yaml
    with:
      app-name: ordering

  sonar:
    runs-on: ubuntu-latest
    needs: [bff, delivery, food, ordering]
    steps:

      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: bff-code-coverage
          path: ./services/bff/build/reports/jacoco/test/jacocoTestReport.xml

      - uses: actions/download-artifact@v3
        with:
          name: delivery-code-coverage
          path: ./services/delivery/build/reports/jacoco/test/jacocoTestReport.xml

      - uses: actions/download-artifact@v3
        with:
          name: food-code-coverage
          path: ./services/food/build/reports/jacoco/test/jacocoTestReport.xml

      - uses: actions/download-artifact@v3
        with:
          name: ordering-code-coverage
          path: ./services/ordering/build/reports/jacoco/test/jacocoTestReport.xml

      - name: Sonar Cloud ðŸŒŸ
        working-directory: services
        run: |
          ./gradlew sonarqube -Dsonar.host.url=https://sonarcloud.io -Dsonar.verbose=true --info
        env:
          GITHUB_TOKEN: ${{ secrets.githubToken }}
          SONAR_TOKEN: ${{ secrets.sonarToken }}
