version: '3'

vars:
  GREETING: Hello, World!

tasks:
  default:
    cmds:
      - echo "{{.GREETING}}"
    silent: true

  check:
    desc: Verify local tools
    cmds:
      - docker --info
      - java --version
      - gradlew --help

  infra:
    desc: Spin up dockerized infrastructure (postgres db)
    cmds:
      - docker compose up -d
      - docker run -it --network food-delivery-app_default redis redis-cli -h redis FT.CREATE food-idx ON JSON PREFIX 1 "food:" SCHEMA $.name AS name TEXT

  local:
    desc: Run app with infrastructure locally
    cmds:
      - task: infra
      - echo "Starting food-delivery app..."
      - gradlew clean assemble --info
      - gradlew --parallel startBootStack --info

  infra-down:
    desc: Stop infrastructure
    cmds:
      - docker compose down
      - echo "All infra apps stopped."

  infra-clean:
    desc: Stop and clean all persisted data
    cmds:
      - task: infra-down
      - docker volume rm food-delivery-app_postgres-data
      - docker volume rm food-delivery-app_redis-data
      - echo "Docker volumes cleaned."
